sudo: false

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - g++-4.9

matrix:
  include:
    # linux
    - os: linux   # abi 47
      env: NODE_VERSION="5.1.1" TARGET_ARCH="x64" CXX=g++-4.9
    - os: linux   # abi 48
      env: NODE_VERSION="6" TARGET_ARCH="x64" CXX=g++-4.9
    - os: linux   # abi 49
      env: NODE_VERSION="6" ELECTRON="1.3.6" TARGET_ARCH="x64" CXX=g++-4.9
    # os x x86
    - os: osx
      env: NODE_VERSION="5.1.1" TARGET_ARCH="x64" CXX="clang"
    - os: osx
      env: NODE_VERSION="6" TARGET_ARCH="x64" CXX="clang"
    - os: osx
      env: NODE_VERSION="6" ELECTRON="1.3.6" TARGET_ARCH="x64" CXX="clang"
    # osx ia32
    - os: osx
      env: NODE_VERSION="5.1.1" TARGET_ARCH="ia32" CXX="clang"
    - os: osx
      env: NODE_VERSION="6" TARGET_ARCH="ia32" CXX="clang"
    - os: osx
      env: NODE_VERSION="6" ELECTRON="1.3.6" TARGET_ARCH="ia32" CXX="clang"

before_install:
  - rm -rf ~/.nvm/ && git clone --depth 1 "https://github.com/creationix/nvm.git" ~/.nvm
  - source ~/.nvm/nvm.sh
  - nvm install $NODE_VERSION
  - nvm use $NODE_VERSION
  - export PATH="$(pwd)/node_modules/.bin/:$PATH"

install:
  - npm install

script:
  - if [[ -z "$ELECTRON" ]]; then
      node-pre-gyp rebuild package testpackage
        --build-from-source --target_arch=$TARGET_ARCH;
    else
      node-pre-gyp rebuild package testpackage
        --runtime=electron --target=$ELECTRON
        --dist-url=https://atom.io/download/atom-shell
        --build-from-source --target_arch=$TARGET_ARCH;
    fi
  - if [[ "$TARGET_ARCH" == "x64" && -z "$ELECTRON" ]]; then
      npm test;
    fi

git:
  depth: 10

branches:
  only:
    - master
    - /^v\d+\.\d+\.\d+(?:-[a-z0-9.-]+)?$/

before_deploy:
  - export RELEASE_NODE_FILE=$(find build/stage -name '*.tar.gz')
  - echo "Deploying $RELEASE_NODE_FILE to GitHub"

deploy:
  provider: releases
  api_key:
    secure: dIis0UjZoP+p13YRimTuFyAUhcYzPnSQJMeNNbAX0LWSt0E0rij6oB2zmdvgNmxY5E65U8nrztG9HErmLElN1xCrr4mzt/hkuvE/pod4OcF0J3aYuKmccIkQDtId5C1Fi24rAecFGKqHgkrfOJugnsefh9bjKYl3pVVQFe83/cYHtE5wPOZD41K+H64TY8JznMtbNQkThiawe3MpEofCZoptrdXcKUTOSBhZrFM7qc5dXti42DSwNu0s5f6E/loSg5MCVkxSr9ytrlUN4vJVUj6vEOA1iniFWA4cUd6j5bW+bfv9tt+5lMPmWOoLymeYXmQVupx0usxrgWbuMN7+J1B00LUx1rGF6ILfyJiC3IHRgPllOApsPiK3NQCVcnRz4cvyYWZ/5Pb0ugaZHokKVnTc57OWtrCEj6SfAsmvt5UjldDD98FJaJ3bGe5AGFwFbE1QBTc6xALCnoYFBEAgUWbyZHniZV4YeGo+lXT/6ByVW2RnC+dV9aJkhtYLrfnCJAginf5yyhpR49ldWJTrYY2kA86oejQGI5muhhK2eeW2ndXbPi+eUKzTpL23Gpo2iY/tyKxVxzXtEvcSUaAaGabCcaK8OQJiDDDgsfzTZxIdKLI18D4pNRQKYFezBdLFLjCjrVRuypBAY+jz6Zvy6G5usZUw36dD1KoRS2ibO6w=
  file: '"$RELEASE_NODE_FILE"'
  on:
    repo: rightparen/pty.js-prebuilt
    tags: true
